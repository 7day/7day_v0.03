/* Questo modulo servirà per eseguire le istruzioni SQL sul DB *//* Questa funzione ha il compito di reperire l'istruzione SQL da eseguire */exports.readSqlText = function readSqlText (sqlcod) {		var stmt = ds.SqlFactory.find("sqlcod == :1", sqlcod);	if(stmt!=null)	{	   return stmt.sqlstmt;	}	else	{		console.error("ERR: Istruzione SQL non trovata: ", sqlcod);		return "ERR: Istruzione SQL non trovata: "+ sqlcod	}	};/*     Questa funzione ha il compito di eseguire delle istruzioni di modifica    sul db (insert, update, delete) che sono memorizzate nella tabella    SqlFactory. E' da ottimizzare. Si potrebbero utilizzare degli array     associativi.        var campi = [];	campi[0]=new Array("<D1CODAZIE>","N",1);	campi[1]=new Array("<D1CODMENU>","S",$$('d1codmenu').getValue());	campi[2]=new Array("<D1DESMUBR>","S",$$('d1desmubr').getValue());	campi[3]=new Array("<D1DESMUDL>","S",$$('d1desmudl').getValue());	campi[4]=new Array("<D1GENNOTE>","S",$$('d1gennote').getValue());        Nel primo elemento mettiamo il marker da sostiruire, poi c'è il tipo    del campo ed infine il valore.    */exports.updateDB = function updateDB (stmt, connectionParams, campi) {		try	{		debugger;						var dbconn = require('waf-mysql');		var utils = require('core/Utils');	    var connection= dbconn.connect(connectionParams);		    /* Preparo la query */	    	    for(i=0;i<campi.length;i++)	    {	    		    	if(campi[i][1]=="S") //Stringa	    	{	    		stmt = utils.FindAndReplace(stmt,	    		                            campi[i][0],	    		                            utils.formatStringDb(campi[i][2]));	    	}	    	else if (campi[i][1]=="N") //Numero	    	{	    	    stmt = utils.FindAndReplace(stmt,	    		                            campi[i][0],	    		                            utils.formatNumberDb(campi[i][2]));	    	}	    	else if(campi[i][1]=="D") //Data	    	{	    	    stmt = utils.FindAndReplace(stmt,		    		                        campi[i][0],		    		                        utils.formatDateDb(campi[i][2]));	    	}	    			    }	    	    	    connection.execute(stmt);	    connection.close();	    return "Aggiornamento eseguito";	}	catch(err)	{		        console.error("Aggiornamento fallito", err.message);		return err.message;	}}/*     Questa funzione ha il compito di eseguire delle istruzioni SQL per leggere    i dati dalle tabelle. Le istruzioni si troveranno sempre memorizzate nella    tabella SqlFactory */exports.selectDB = function selectDB (stmt, connectionParams, campi) {		try	{		debugger;						var dbconn = require('waf-mysql');		var utils = require('core/Utils');	    var connection= dbconn.connect(connectionParams);	    var res, result;		    /* Preparo la query */	    	    for(i=0;i<campi.length;i++)	    {	    		    	if(campi[i][1]=="S") //Stringa	    	{	    		stmt = utils.FindAndReplace(stmt,	    		                            campi[i][0],	    		                            utils.formatStringDb(campi[i][2]));	    	}	    	else if (campi[i][1]=="N") //Numero	    	{	    	    stmt = utils.FindAndReplace(stmt,	    		                            campi[i][0],	    		                            utils.formatNumberDb(campi[i][2]));	    	}	    	else if(campi[i][1]=="D") //Data	    	{	    	    stmt = utils.FindAndReplace(stmt,		    		                        campi[i][0],		    		                        utils.formatDateDb(campi[i][2]));	    	}	    			    }	    	    res = connection.execute(stmt);		result = res.getAllRows();	    connection.close();	    	    return result;	}	catch(err)	{		        console.error("Errore in lettura tabella", err.message);		return err.message;	}		}/*    Questa funzione ha il compito di comporre in modo dinamico una istruzione    SQL di select.        tabella=tabelle principate da leggere        campiselect=elenco dei campi da leggere        join=tabelle in join da utilizzare        campiand=selezione campi in and (campo, tipo, operatore, valore1)        campior=selezione campi in or (campo, tipo, operatore, valore1)        campiorder=campi di ordinamento*/exports.findDB = function findDB (connectionParams, tabella, campiselect, join, campiand, campior, campiorder) {		try	{		debugger;				var dbconn = require('waf-mysql');		var utils = require('core/Utils');		var query="select";		var primogiroAnd=true;		var primogiroOr=true;		var chiudoOr;		var connection= dbconn.connect(connectionParams);	    var res, result;								/* Campi da leggere */		query = query + " " + campiselect;				/* Tabella principale */		query = query + " " + "from" + " " + tabella;				/* Tabelle in join */		for(i=0;i<join.length;i++)		{			query = query + " " + join[i];		}				/* Gestisco i campi di selezione AND */		for(i=0;i<campiand.length;i++)		{			if (primogiroAnd)			{				query = query + " " + "where";						}					    if(campiand[i][1]=="S") //Stringa		    {		    	query = query + (primogiroAnd==true?" ":" and ") + campiand[i][0] + " " + campiand[i][2] + " " + utils.formatStringDb(campiand[i][3]);		    }		    else if (campiand[i][1]=="N") //Numero		    {		    	query = query + (primogiroAnd==true?" ":" and ") + campiand[i][0] + " " + campiand[i][2] + " " + utils.formatNumberDb(campiand[i][3]);		    }		    else if(campiand[i][1]=="D") //Data		    {		    	query = query + (primogiroAnd==true?" ":" and ") + campiand[i][0] + " " + campiand[i][2] + " " + utils.formatNumberDb(campiand[i][3]);		    }						primogiroAnd=false;		}				if(campior.length>0)		{			/* Gestisco i campi di selezione OR */			if(!primogiroAnd)			{				query = query + " " + " and (";				chiudoOr=")"; 			}			else			{				query = query + " " + "where";				chiudoOr="";			}									/* Gestisco i campi di selezione OR */			for(i=0;i<campior.length;i++)			{								if(campior[i][1]=="S") //Stringa			    {			    	query = query + (primogiroOr==true?" ":" or ") + campior[i][0] + " " + campior[i][2] + " " + utils.formatStringDb(campior[i][3]);			    }			    else if (campior[i][1]=="N") //Numero			    {			    	query = query + (primogiroOr==true?" ":" or ") + campior[i][0] + " " + campior[i][2] + " " + utils.formatNumberDb(campior[i][3]);			    }			    else if(campior[i][1]=="D") //Data			    {			    	query = query + (primogiroOr==true?" ":" or ") + campior[i][0] + " " + campior[i][2] + " " + utils.formatNumberDb(campior[i][3]);			    }								primogiroOr=false;							}						query = query + " " + chiudoOr;		}				/* Aggoingo ordinamento */		query = query + " " + " order by " + campiorder;				    res = connection.execute(query);		result = res.getAllRows();	    connection.close();	    	    return result;			}	catch(err)	{		        console.error("Errore in lettura tabella", err.message);		return err.message;	}		}