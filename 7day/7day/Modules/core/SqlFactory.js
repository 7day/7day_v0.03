/* Questo modulo servirà per eseguire le istruzioni SQL sul DB *//* Questa funzione ha il compito di reperire l'istruzione SQL da eseguire */exports.readSqlText = function readSqlText (sqlcod) {		var stmt = ds.SqlFactory.find("sqlcod == :1", sqlcod);	if(stmt!=null)	{	   return stmt.sqlstmt;	}	else	{		console.error("ERR: Istruzione SQL non trovata: ", sqlcod);		return "ERR: Istruzione SQL non trovata: "+ sqlcod	}	};/*     Questa funzione ha il compito di eseguire delle istruzioni di modifica    sul db (insert, update, delete) che sono memorizzate nella tabella    SqlFactory. E' da ottimizzare. Si potrebbero utilizzare degli array     associativi.    	var field = [];	field[0]=new Array(":d1codazie","N",1);	field[1]=new Array(":d1codmenu","S",$$('d1codmenu').getValue());	field[2]=new Array(":d1desmubr","S",$$('d1desmubr').getValue());	field[3]=new Array(":d1desmudl","S",$$('d1desmudl').getValue());	field[4]=new Array(":d1gennote","S",$$('d1gennote').getValue());        Nel primo elemento mettiamo il marker da sostiruire, poi c'è il tipo    del campo ed infine il valore.    */exports.updateDB = function updateDB (stmt, connectionParams, field) {		try	{		debugger;						var dbconn = require('waf-mysql');		var utils = require('core/Utils');	    var connection= dbconn.connect(connectionParams);		    /* Preparo la stmt */	    	    for(i=0;i<field.length;i++)	    {	    		    	if(field[i][1]=="S") //Stringa	    	{	    		stmt = utils.FindAndReplace(stmt,	    		                            field[i][0],	    		                            utils.formatStringDb(field[i][2]));	    	}	    	else if (field[i][1]=="N") //Numero	    	{	    	    stmt = utils.FindAndReplace(stmt,	    		                            field[i][0],	    		                            utils.formatNumberDb(field[i][2]));	    	}	    	else if(field[i][1]=="D") //Data	    	{	    	    stmt = utils.FindAndReplace(stmt,		    		                        field[i][0],		    		                        utils.formatDateDb(field[i][2]));	    	}	    			    }	    	    	    connection.execute(stmt);	    connection.close();	    return "Aggiornamento eseguito";	}	catch(err)	{		        console.error("Aggiornamento fallito", err.message);		return err.message;	}}/*     Questa funzione ha il compito di eseguire delle istruzioni SQL per leggere    i dati dalle tabelle. Le istruzioni si troveranno sempre memorizzate nella    tabella SqlFactory */exports.selectDB = function selectDB (stmt, connectionParams, field) {		try	{		debugger;						var dbconn = require('waf-mysql');		var utils = require('core/Utils');	    var connection= dbconn.connect(connectionParams);	    var res, result;		    /* Preparo la stmt */	    	    for(i=0;i<field.length;i++)	    {	    		    	if(field[i][1]=="S") //Stringa	    	{	    		stmt = utils.FindAndReplace(stmt,	    		                            field[i][0],	    		                            utils.formatStringDb(field[i][2]));	    	}	    	else if (field[i][1]=="N") //Numero	    	{	    	    stmt = utils.FindAndReplace(stmt,	    		                            field[i][0],	    		                            utils.formatNumberDb(field[i][2]));	    	}	    	else if(field[i][1]=="D") //Data	    	{	    	    stmt = utils.FindAndReplace(stmt,		    		                        field[i][0],		    		                        utils.formatDateDb(field[i][2]));	    	}	    			    }	    	    res = connection.execute(stmt);		result = res.getAllRows();	    connection.close();	    	    return result;	}	catch(err)	{		        console.error("Errore in lettura tabella", err.message);		return err.message;	}		}/*    Questa funzione ha il compito di comporre in modo dinamico una istruzione    SQL di select.       tabella=tabelle principate da leggere        campiselect=elenco dei campi da leggere    join=tabelle in join da utilizzare    campiand=selezione campi in and (campo, tipo, operatore, campodasostituire, valore)    campior=selezione campi in or (campo, tipo, operatore, campodasostituire, valore)    campiorder=campi di ordinamento*/exports.findDB = function findDB (connectionParams, table, fieldselect, join, fieldand, fieldor, fieldorder) {		try	{		debugger;				var dbconn = require('waf-mysql');		var utils = require('core/Utils');		var stmt="select";		var primogiroAnd=true;		var primogiroOr=true;		var chiudoOr;		var connection= dbconn.connect(connectionParams);	    var res, result;								/* Campi da leggere */		stmt = stmt + " " + fieldselect;				/* Tabella principale */		stmt = stmt + " " + "from" + " " + table;				/* Tabelle in join */		for(i=0;i<join.length;i++)		{			stmt = stmt + " " + join[i];		}				/* Gestisco i campi di selezione AND */		for(i=0;i<fieldand.length;i++)		{			if (primogiroAnd)			{				stmt = stmt + " " + "where";						}					    stmt = stmt + (primogiroAnd==true?" ":" and ") + fieldand[i][0] + " " + fieldand[i][2] + " " + fieldand[i][3];			primogiroAnd=false;		}				if(fieldor.length>0)		{			/* Gestisco i campi di selezione OR */			if(!primogiroAnd)			{				stmt = stmt + " " + " and (";				chiudoOr=")"; 			}			else			{				stmt = stmt + " " + "where";				chiudoOr="";			}						for(i=0;i<fieldor.length;i++)			{			    stmt = stmt + (primogiroOr==true?" ":" or ") + fieldor[i][0] + " " + fieldor[i][2] + " " + fieldor[i][3];				primogiroOr=false;							}						stmt = stmt + " " + chiudoOr;		}				/* Aggiungo ordinamento */		if(fieldorder!="")			stmt = stmt + " " + " order by " + fieldorder;									/* Sostituzione dei valori AND */		for(i=0;i<fieldand.length;i++)		{		    if(fieldand[i][1]=="S") //Stringa	    	{	    		stmt = utils.FindAndReplace(stmt,	    		                            fieldand[i][3],	    		                            utils.formatStringDb(fieldand[i][4]));	    	}	    	else if (fieldand[i][1]=="N") //Numero	    	{	    	    stmt = utils.FindAndReplace(stmt,	    		                            fieldand[i][3],	    		                            utils.formatNumberDb(fieldand[i][4]));	    	}	    	else if(fieldand[i][1]=="D") //Data	    	{	    	    stmt = utils.FindAndReplace(stmt,		    		                        fieldand[i][3],		    		                        utils.formatDateDb(fieldand[i][4]));	    	}		}				/* Sostituzione dei valori OR */		for(i=0;i<fieldor.length;i++)		{		    if(fieldor[i][1]=="S") //Stringa	    	{	    		stmt = utils.FindAndReplace(stmt,	    		                            fieldor[i][3],	    		                            utils.formatStringDb(fieldor[i][4]));	    	}	    	else if (fieldor[i][1]=="N") //Numero	    	{	    	    stmt = utils.FindAndReplace(stmt,	    		                            fieldor[i][3],	    		                            utils.formatNumberDb(fieldor[i][4]));	    	}	    	else if(fieldor[i][1]=="D") //Data	    	{	    	    stmt = utils.FindAndReplace(stmt,		    		                        fieldor[i][3],		    		                        utils.formatDateDb(fieldor[i][4]));	    	}		}			    res = connection.execute(stmt);		result = res.getAllRows();	    connection.close();	    	    return result;			}	catch(err)	{		        console.error("Errore in lettura tabella", err.message);		return err.message;	}		}